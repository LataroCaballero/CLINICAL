generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum RolUsuario {
  ADMIN
  PROFESIONAL
  SECRETARIA
  PACIENTE
  FACTURADOR
}

model Permiso {
  id        String     @id @default(uuid())
  rol       RolUsuario
  modulo    String
  accion    String
  permitido Boolean    @default(true)
}

model Usuario {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String
  rol          RolUsuario

  nombre   String
  apellido String
  telefono String?
  fotoUrl  String?

  // Relación con perfiles según rol
  profesional Profesional?
  secretaria  Secretaria?
  paciente    Paciente?

  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  LiquidacionObraSocial LiquidacionObraSocial[]
  MovimientoStock       MovimientoStock[]

  tokens      RefreshToken[]
  AuthSession AuthSession[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      Usuario  @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model AuthSession {
  id     String  @id @default(uuid())
  userId String
  user   Usuario @relation(fields: [userId], references: [id])

  refreshToken String?  @unique
  device       String?
  ipAddress    String?
  userAgent    String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  expiresAt  DateTime
  lastUsedAt DateTime @default(now())

  revoked   Boolean   @default(false)
  revokedAt DateTime?
}

model Profesional {
  id        String  @id @default(uuid())
  usuarioId String  @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  matricula       String?
  especialidad    String?
  bio             String?
  duracionDefault Int? // duración estándar de turnos

  // Configuración de agenda
  agenda Json? // días, horarios, consultorios

  // Relaciones
  pacientes Paciente[]          @relation("ProfesionalPaciente")
  turnos    Turno[]
  cirugias  Cirugia[]
  practicas PracticaRealizada[]

  createdAt       DateTime          @default(now())
  HistoriaClinica HistoriaClinica[]
  Presupuesto     Presupuesto[]
  Factura         Factura[]
}

model Secretaria {
  id        String  @id @default(uuid())
  usuarioId String  @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  // Datos opcionales adicionales
  horarioTrabajo Json?
  permisosExtras Json?

  createdAt DateTime @default(now())
}

// ------------------------------
// ENUMS
// ------------------------------
enum EstadoPaciente {
  ACTIVO
  ARCHIVADO
  QUIRURGICO
  PRESUPUESTO
  PRIMERA
  PRACTICA_CONSULTORIO
}

// ------------------------------
// PACIENTE
// ------------------------------
model Paciente {
  id        String   @id @default(uuid())
  usuarioId String?  @unique
  usuario   Usuario? @relation(fields: [usuarioId], references: [id])

  nombreCompleto      String
  dni                 String    @unique
  fechaNacimiento     DateTime?
  telefono            String
  telefonoAlternativo String?
  email               String?
  direccion           String?
  fotoUrl             String?

  // Datos médicos
  obraSocialId      String?
  plan              String?
  alergias          String[] // Array de strings
  condiciones       String[] // Preexistentes
  diagnostico       String?
  tratamiento       String?
  deriva            String?
  lugarIntervencion String?

  // Objetivos del paciente
  objetivos String?

  // Consentimientos
  consentimientoFirmado     Boolean   @default(false)
  consentimientosDocumentos Archivo[] @relation("PacienteConsentimientos")

  // Estudios necesarios
  estudios EstudioPaciente[]

  // Indicaciones
  indicacionesEnviadas Boolean   @default(false)
  fechaIndicaciones    DateTime?

  // Administrativo
  estado           EstadoPaciente   @default(ACTIVO)
  mensajesInternos MensajeInterno[]

  // Contacto de emergencia
  contactoEmergenciaNombre   String?
  contactoEmergenciaTelefono String?
  contactoEmergenciaRelacion String?

  // Relaciones externas
  historiasClinicas HistoriaClinica[]

  cuentaCorriente CuentaCorriente?

  profesionalId String?
  profesional   Profesional? @relation("ProfesionalPaciente", fields: [profesionalId], references: [id])

  turnos       Turno[]
  presupuestos Presupuesto[]
  archivos     Archivo[]     @relation("ArchivosPaciente")

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  VentaProducto VentaProducto[]
}

// ------------------------------
// MENSAJES INTERNOS (tipo chat)
// ------------------------------
model MensajeInterno {
  id          String   @id @default(uuid())
  mensaje     String
  autorUserId String
  pacienteId  String
  paciente    Paciente @relation(fields: [pacienteId], references: [id])
  timestamp   DateTime @default(now())
}

// ------------------------------
// ESTUDIOS NECESARIOS
// ------------------------------
model EstudioPaciente {
  id            String    @id @default(uuid())
  nombre        String
  solicitadoPor String?
  estado        Boolean   @default(false)
  fechaEntrega  DateTime?
  pacienteId    String
  paciente      Paciente  @relation(fields: [pacienteId], references: [id])
}

// ------------------------------
// HISTORIA CLÍNICA
// ------------------------------
model HistoriaClinica {
  id String @id @default(uuid())

  pacienteId String
  paciente   Paciente @relation(fields: [pacienteId], references: [id])

  profesionalId String
  profesional   Profesional @relation(fields: [profesionalId], references: [id])

  entradas HistoriaClinicaEntrada[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ------------------------------
// ENTRADAS DE HISTORIA CLÍNICA
// ------------------------------
model HistoriaClinicaEntrada {
  id                String   @id @default(uuid())
  historiaClinicaId String
  fecha             DateTime @default(now())

  // Texto enriquecido (JSON porque vas a usar editor tipo TipTap, Quill o similar)
  contenido Json?

  // Firma del profesional (base64, URL o booleano según implementación)
  firmaProfesional String?

  // Relación con HC
  historiaClinica HistoriaClinica @relation(fields: [historiaClinicaId], references: [id])

  // Pago opcional asociado a esta consulta
  pago MovimientoCC?

  // Archivos adjuntos
  archivos Archivo[] @relation("ArchivosEntradaHC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Turno     Turno[]
}

// ------------------------------
// ARCHIVOS
// Se reutiliza el modelo, pero se agrega la relación a HC Entrada
// ------------------------------
model Archivo {
  id          String  @id @default(uuid())
  url         String
  tipo        String // ejemplo: "pdf", "jpeg", "mp4"
  descripcion String?

  // Archivo subido por un paciente
  pacienteId String?
  paciente   Paciente? @relation("ArchivosPaciente", fields: [pacienteId], references: [id])

  // Archivo de consentimiento firmado del paciente
  consentimientoPacienteId String?
  consentimientoPaciente   Paciente? @relation("PacienteConsentimientos", fields: [consentimientoPacienteId], references: [id])

  // Archivo adjunto a una entrada de Historia Clínica
  entradaHCId String?
  entradaHC   HistoriaClinicaEntrada? @relation("ArchivosEntradaHC", fields: [entradaHCId], references: [id])

  // Archivo asociado a un Presupuesto (Documento PDF enviado)
  presupuestoId String?
  presupuesto   Presupuesto? @relation(fields: [presupuestoId], references: [id])

  // Archivo asociado a Factura o Recibo (PDF para descargar)
  facturaId String?
  factura   Factura? @relation(fields: [facturaId], references: [id])

  createdAt DateTime @default(now())
}

// ------------------------------
// CUENTA CORRIENTE
// ------------------------------
model CuentaCorriente {
  id         String   @id @default(uuid())
  pacienteId String   @unique
  paciente   Paciente @relation(fields: [pacienteId], references: [id])

  movimientos MovimientoCC[]

  // Estado del paciente respecto al dinero
  saldoActual          Decimal @default(0.0) @db.Decimal(10, 2)
  totalPagadoHistorico Decimal @default(0.0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ------------------------------
// MOVIMIENTOS DE CUENTA CORRIENTE
// ------------------------------
enum TipoMovimiento {
  CARGO
  PAGO
}

model MovimientoCC {
  id                String          @id @default(uuid())
  cuentaCorrienteId String
  cuentaCorriente   CuentaCorriente @relation(fields: [cuentaCorrienteId], references: [id])

  monto       Decimal        @db.Decimal(10, 2)
  tipo        TipoMovimiento
  descripcion String?
  fecha       DateTime       @default(now())

  // Relación opcional con historia clínica
  historiaClinicaEntradaId String?                 @unique
  entradaHC                HistoriaClinicaEntrada? @relation(fields: [historiaClinicaEntradaId], references: [id])

  // Relación opcional con presupuestos
  presupuestoId String?
  presupuesto   Presupuesto? @relation("PagosPresupuesto", fields: [presupuestoId], references: [id])

  // Relación opcional con venta de productos
  ventaProducto VentaProducto?

  // Relación opcional con turnos
  turnoId     String?
  turno       Turno?        @relation(fields: [turnoId], references: [id])
  Presupuesto Presupuesto[]
  Factura     Factura[]
}

// ------------------------------
// ENUM
// ------------------------------
enum EstadoPresupuesto {
  BORRADOR
  ENVIADO
  ACEPTADO
  RECHAZADO
  CANCELADO
}

// ------------------------------
// PRESUPUESTO
// ------------------------------
model Presupuesto {
  id            String @id @default(uuid())
  pacienteId    String
  profesionalId String

  paciente    Paciente    @relation(fields: [pacienteId], references: [id])
  profesional Profesional @relation(fields: [profesionalId], references: [id])

  // Ítems del presupuesto
  items PresupuestoItem[]

  // Totales
  subtotal   Decimal @db.Decimal(10, 2)
  descuentos Decimal @default(0) @db.Decimal(10, 2)
  total      Decimal @db.Decimal(10, 2)

  // Estado
  estado EstadoPresupuesto @default(BORRADOR)

  // Seguimiento
  fechaEnviado   DateTime?
  fechaAceptado  DateTime?
  fechaRechazado DateTime?
  motivoRechazo  String?

  // Relación con la Cuenta Corriente
  // Si se acepta → generamos un MovimientoCC
  cargoMovimientoId String?
  cargoMovimiento   MovimientoCC? @relation(fields: [cargoMovimientoId], references: [id])

  // Pagos parciales asociados
  pagos MovimientoCC[] @relation("PagosPresupuesto")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Archivo   Archivo[]
}

// ------------------------------
// ÍTEMS DEL PRESUPUESTO
// ------------------------------
model PresupuestoItem {
  id            String      @id @default(uuid())
  presupuestoId String
  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id])

  descripcion    String
  cantidad       Int     @default(1)
  precioUnitario Decimal @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  orden Int @default(0)
}

// ------------------------------
// OBRA SOCIAL
// ------------------------------

model ObraSocial {
  id           String  @id @default(uuid())
  nombre       String
  cuit         String?
  domicilio    String?
  condicionIVA String?

  planes                PlanObraSocial[]
  practicas             PracticaObraSocial[]
  LiquidacionObraSocial LiquidacionObraSocial[]
}

model PlanObraSocial {
  id           String     @id @default(uuid())
  obraSocialId String
  obraSocial   ObraSocial @relation(fields: [obraSocialId], references: [id])

  nombre    String
  cobertura String?
}

model PracticaObraSocial {
  id           String     @id @default(uuid())
  obraSocialId String
  obraSocial   ObraSocial @relation(fields: [obraSocialId], references: [id])

  codigo      String
  descripcion String
  monto       Decimal @db.Decimal(10, 2)
}

enum EstadoLiquidacion {
  PENDIENTE
  PAGADO
}

model PracticaRealizada {
  id            String  @id @default(uuid())
  pacienteId    String
  profesionalId String
  obraSocialId  String?

  // Datos de la práctica
  codigo      String
  descripcion String
  monto       Decimal @db.Decimal(10, 2)
  coseguro    Decimal @default(0) @db.Decimal(10, 2)

  fecha DateTime @default(now())

  // Estado de liquidación para obras sociales
  estadoLiquidacion EstadoLiquidacion      @default(PENDIENTE)
  liquidacionId     String?
  liquidacion       LiquidacionObraSocial? @relation(fields: [liquidacionId], references: [id])

  // Puede generar una factura o recibo
  facturaId       String?
  factura         Factura?          @relation(fields: [facturaId], references: [id])
  Profesional     Profesional       @relation(fields: [profesionalId], references: [id])
  MovimientoStock MovimientoStock[]
}

model LiquidacionObraSocial {
  id           String     @id @default(uuid())
  obraSocialId String
  obraSocial   ObraSocial @relation(fields: [obraSocialId], references: [id])

  periodo    String
  fechaPago  DateTime?
  montoTotal Decimal   @db.Decimal(10, 2)
  usuarioId  String? // facturador o admin
  usuario    Usuario?  @relation(fields: [usuarioId], references: [id])

  practicas PracticaRealizada[]

  facturaId String?
  factura   Factura? @relation(fields: [facturaId], references: [id])

  createdAt DateTime @default(now())
}

enum TipoFactura {
  FACTURA
  RECIBO
}

model Factura {
  id     String      @id @default(uuid())
  tipo   TipoFactura
  numero String      @unique
  fecha  DateTime    @default(now())

  // Datos fiscales
  cuit        String?
  razonSocial String?
  domicilio   String?

  subtotal  Decimal @db.Decimal(10, 2)
  impuestos Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  // Para OS o particular
  liquidaciones LiquidacionObraSocial[]

  profesionalId String
  profesional   Profesional @relation(fields: [profesionalId], references: [id])

  practicas PracticaRealizada[]

  movimientoId  String? // recibo registrado como pago particular
  movimiento    MovimientoCC?   @relation(fields: [movimientoId], references: [id])
  Archivo       Archivo[]
  VentaProducto VentaProducto[]
}

model VentaProducto {
  id         String    @id @default(uuid())
  pacienteId String?
  paciente   Paciente? @relation(fields: [pacienteId], references: [id])

  total     Decimal  @db.Decimal(10, 2)
  medioPago String
  fecha     DateTime @default(now())

  // Ítems de la venta
  items VentaProductoItem[]

  // Relación financiera (pago generado en CC)
  movimientoId String?       @unique
  movimiento   MovimientoCC? @relation(fields: [movimientoId], references: [id])

  // Factura generada (si aplica)
  facturaId       String?
  factura         Factura?          @relation(fields: [facturaId], references: [id])
  MovimientoStock MovimientoStock[]
}

model VentaProductoItem {
  id              String        @id @default(uuid())
  ventaProductoId String
  ventaProducto   VentaProducto @relation(fields: [ventaProductoId], references: [id])

  productoId String
  producto   Producto @relation(fields: [productoId], references: [id])

  cantidad       Int
  precioUnitario Decimal @db.Decimal(10, 2)
  subtotal       Decimal @db.Decimal(10, 2)
}

model Producto {
  id          String  @id @default(uuid())
  nombre      String
  categoria   String?
  descripcion String?
  sku         String? @unique
  imagenUrl   String?

  tipo         TipoProducto
  unidadMedida String?

  // Costos base (histórico solo referencial)
  costoBase      Decimal? @db.Decimal(10, 2)
  precioSugerido Decimal? @db.Decimal(10, 2)

  requiereLote   Boolean @default(false)
  descuentaStock Boolean @default(true)

  inventario        Inventario?
  lotes             Lote[]
  proveedores       ProductoProveedor[]
  VentaProductoItem VentaProductoItem[]
  OrdenCompraItem   OrdenCompraItem[]
}

enum TipoProducto {
  INSUMO
  PRODUCTO_VENTA
  USO_INTERNO
}

model Inventario {
  id         String   @id @default(uuid())
  productoId String   @unique
  producto   Producto @relation(fields: [productoId], references: [id])

  stockActual    Int @default(0)
  stockMinimo    Int @default(0)
  stockReservado Int @default(0)

  precioActual Decimal? @db.Decimal(10, 2)

  movimientos MovimientoStock[]
}

enum TipoMovimientoStock {
  ENTRADA
  SALIDA
  AJUSTE
}

model MovimientoStock {
  id           String     @id @default(uuid())
  inventarioId String
  inventario   Inventario @relation(fields: [inventarioId], references: [id])

  tipo     TipoMovimientoStock
  cantidad Int
  motivo   String?

  fecha     DateTime @default(now())
  usuarioId String?
  usuario   Usuario? @relation(fields: [usuarioId], references: [id])

  // Relaciones opcionales
  ventaProductoId String?
  ventaProducto   VentaProducto? @relation(fields: [ventaProductoId], references: [id])

  practicaId String?
  practica   PracticaRealizada? @relation(fields: [practicaId], references: [id])

  ordenCompraId String?
  ordenCompra   OrdenCompra? @relation(fields: [ordenCompraId], references: [id])

  loteId String?
  lote   Lote?   @relation(fields: [loteId], references: [id])
}

model Lote {
  id         String   @id @default(uuid())
  productoId String
  producto   Producto @relation(fields: [productoId], references: [id])

  lote             String?
  fechaVencimiento DateTime?

  cantidadInicial Int
  cantidadActual  Int

  movimientos MovimientoStock[]
}

model Proveedor {
  id        String  @id @default(uuid())
  nombre    String
  cuit      String?
  direccion String?
  telefono  String?
  email     String?

  productos   ProductoProveedor[]
  OrdenCompra OrdenCompra[]
}

model ProductoProveedor {
  id          String @id @default(uuid())
  productoId  String
  proveedorId String

  producto  Producto  @relation(fields: [productoId], references: [id])
  proveedor Proveedor @relation(fields: [proveedorId], references: [id])

  precioHistorico Decimal? @db.Decimal(10, 2)
}

enum EstadoOrdenCompra {
  PENDIENTE
  ENVIADA
  RECIBIDA
  CANCELADA
}

model OrdenCompra {
  id          String    @id @default(uuid())
  proveedorId String
  proveedor   Proveedor @relation(fields: [proveedorId], references: [id])

  fechaCreacion  DateTime          @default(now())
  fechaRecepcion DateTime?
  estado         EstadoOrdenCompra @default(PENDIENTE)

  items       OrdenCompraItem[]
  movimientos MovimientoStock[] // entradas generadas al recibir
}

model OrdenCompraItem {
  id            String      @id @default(uuid())
  ordenCompraId String
  ordenCompra   OrdenCompra @relation(fields: [ordenCompraId], references: [id])

  productoId String
  producto   Producto @relation(fields: [productoId], references: [id])

  cantidad       Int
  precioUnitario Decimal @db.Decimal(10, 2)
}

model TipoTurno {
  id          String  @id @default(uuid())
  nombre      String  @unique
  descripcion String?

  // Plantilla del mensaje preestructurado
  mensajeBase String? // para WhatsApp/email

  // Plantilla de instrucciones pre-turno
  instrucciones String? // JSON, texto, markdown

  duracionDefault Int? // en minutos, opcional

  turnos Turno[]
}

enum EstadoTurno {
  PENDIENTE
  CONFIRMADO
  CANCELADO
  AUSENTE
  FINALIZADO
}

model Turno {
  id String @id @default(uuid())

  // Relación paciente
  pacienteId String
  paciente   Paciente @relation(fields: [pacienteId], references: [id])

  // Relación profesional
  profesionalId String
  profesional   Profesional @relation(fields: [profesionalId], references: [id])

  // Tipo de turno (consulta, cirugía, etc.)
  tipoTurnoId String
  tipoTurno   TipoTurno @relation(fields: [tipoTurnoId], references: [id])

  // Fecha y duración
  inicio DateTime
  fin    DateTime

  // Estado
  estado EstadoTurno @default(PENDIENTE)

  // Observaciones internas para la clínica
  observaciones String?

  // Mensaje adicional personalizado que acompaña a la plantilla
  comentarioMensaje String?

  // Flag si se enviaron las notificaciones
  notificacionEnviada Boolean @default(false)

  // Para quirófano/cirugía
  esCirugia Boolean  @default(false)
  cirugiaId String?
  cirugia   Cirugia? @relation(fields: [cirugiaId], references: [id])

  // Relación con historia clínica (opcional)
  entradaHCId String?
  entradaHC   HistoriaClinicaEntrada? @relation(fields: [entradaHCId], references: [id])

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  MovimientoCC MovimientoCC[]
}

model Cirugia {
  id            String @id @default(uuid())
  pacienteId    String
  profesionalId String

  fecha       DateTime
  duracion    Int?
  descripcion String?

  turnos      Turno[]
  Profesional Profesional @relation(fields: [profesionalId], references: [id])
}
