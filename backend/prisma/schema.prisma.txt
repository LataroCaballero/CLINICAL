// -----------------------------
//  Prisma Schema – CLINICAL v1.0
// -----------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================
//        MODELO BASE
// =============================

model Consultorio {
  id            String   @id @default(uuid())
  nombre        String
  logo          String?
  colorPrimario String?
  horario       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  sucursales     Sucursal[]
  usuarios       Usuario[]
  profesionales  Profesional[]
  pacientes      Paciente[]
  turnos         Turno[]
  configuracion  Configuracion?
  notificaciones ConfiguracionNotificacion?
  insumos        Insumo[]
  ordenes        OrdenCompra[]
}

model Sucursal {
  id            String      @id @default(uuid())
  nombre        String
  direccion     String?
  horario       String?
  consultorioId String
  consultorio   Consultorio @relation(fields: [consultorioId], references: [id])
}

// =============================
//        USUARIOS / ROLES
// =============================

model Usuario {
  id                     String                  @id @default(uuid())
  nombre                 String
  email                  String                  @unique
  password               String
  rolId                  String
  rol                    Rol                     @relation(fields: [rolId], references: [id])
  tipoRol                TipoRol                 @default(PACIENTE)
  consultorioId          String
  consultorio            Consultorio             @relation(fields: [consultorioId], references: [id])
  asignacionesSecretaria SecretariaProfesional[]

  // Relación inversa con ObraSocial (creador / editor)
  obrasSocialesCreadas  ObraSocial[] @relation("ObraSocialCreador")
  obrasSocialesEditadas ObraSocial[] @relation("ObraSocialEditor")

  solicitudesComoSecretaria  SolicitudAccesoHistoria[] @relation("Secretaria_Solicitudes")
  solicitudesComoProfesional SolicitudAccesoHistoria[] @relation("Profesional_Solicitudes")

  // Relación inversa con Pago (quien registró el pago)
  pagosCreados Pago[] @relation("PagoCreador")

  // Relación con liquidaciones y comprobantes
  liquidacionesCreadas LiquidacionPractica[]    @relation("LiquidacionCreador")
  liquidacionesPagadas LiquidacionPractica[]    @relation("LiquidacionPagador")
  comprobantesEmitidos ComprobanteFacturacion[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  RegistroClinico RegistroClinico[]
  Venta           Venta[]
}

model Rol {
  id          String    @id @default(uuid())
  nombre      String
  descripcion String?
  usuarios    Usuario[]
  permisos    Permiso[]
}

model Permiso {
  id     String @id @default(uuid())
  modulo String
  accion String
  rolId  String
  rol    Rol    @relation(fields: [rolId], references: [id])
}

enum TipoRol {
  ADMIN
  PROFESIONAL
  SECRETARIA
  PACIENTE
  FACTURADOR
}

// =============================
//         SECRETARIAS
// =============================

model SecretariaProfesional {
  id            String @id @default(uuid())
  secretariaId  String
  profesionalId String

  // secretaria = Usuario con rol SECRETARIA
  secretaria  Usuario     @relation(fields: [secretariaId], references: [id])
  // profesional = fila en tabla Profesional
  profesional Profesional @relation(fields: [profesionalId], references: [id])

  // Evita duplicados de asignación
  @@unique([secretariaId, profesionalId])
}

// =============================
//        PROFESIONALES
// =============================

model Profesional {
  id                  String                    @id @default(uuid())
  nombre              String
  apellido            String
  matricula           String?
  consultorioId       String
  consultorio         Consultorio               @relation(fields: [consultorioId], references: [id])
  especialidades      ProfesionalEspecialidad[]
  turnos              Turno[]
  historias           HistoriaClinica[]
  presupuestos        Presupuesto[]
  secretarias         SecretariaProfesional[]
  pagos               Pago[]
  insumos             Insumo[]
  LiquidacionPractica LiquidacionPractica[]
}

model Especialidad {
  id            String                    @id @default(uuid())
  nombre        String
  descripcion   String?
  profesionales ProfesionalEspecialidad[]
}

model ProfesionalEspecialidad {
  id             String       @id @default(uuid())
  profesionalId  String
  especialidadId String
  profesional    Profesional  @relation(fields: [profesionalId], references: [id])
  especialidad   Especialidad @relation(fields: [especialidadId], references: [id])
}

// =============================
//        PACIENTES
// =============================

model Paciente {
  id                  String                    @id @default(uuid())
  nombre              String
  apellido            String
  dni                 String?
  telefono            String?
  email               String?
  obraSocialId        String?
  planId              String?
  obraSocial          ObraSocial?               @relation(fields: [obraSocialId], references: [id])
  plan                PlanObraSocial?           @relation(fields: [planId], references: [id])
  cuentaCorriente     CuentaCorriente?
  historias           HistoriaClinica[]
  turnos              Turno[]
  facturas            Factura[]
  presupuestos        Presupuesto[]
  consultorioId       String
  consultorio         Consultorio               @relation(fields: [consultorioId], references: [id])
  solicitudesAcceso   SolicitudAccesoHistoria[] @relation("Paciente_Solicitudes")
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  LiquidacionPractica LiquidacionPractica[]
  Venta               Venta[]
}

// =============================
//        TURNOS
// =============================

model Turno {
  id            String      @id @default(uuid())
  fecha         DateTime
  estadoId      String
  estado        EstadoTurno @relation(fields: [estadoId], references: [id])
  pacienteId    String
  paciente      Paciente    @relation(fields: [pacienteId], references: [id])
  profesionalId String
  profesional   Profesional @relation(fields: [profesionalId], references: [id])
  consultorioId String
  consultorio   Consultorio @relation(fields: [consultorioId], references: [id])
  observaciones String?
  createdAt     DateTime    @default(now())
}

model EstadoTurno {
  id     String  @id @default(uuid())
  nombre String  @unique
  color  String?
  turnos Turno[]
}

// =============================
//     HISTORIA CLÍNICA
// =============================

model HistoriaClinica {
  id                String                    @id @default(uuid())
  pacienteId        String
  profesionalId     String
  paciente          Paciente                  @relation(fields: [pacienteId], references: [id])
  profesional       Profesional               @relation(fields: [profesionalId], references: [id])
  registros         RegistroClinico[]
  prescripciones    Prescripcion[]
  solicitudesAcceso SolicitudAccesoHistoria[] @relation("Historia_Solicitudes")
  createdAt         DateTime                  @default(now())
}

model RegistroClinico {
  id         String          @id @default(uuid())
  historiaId String
  historia   HistoriaClinica @relation(fields: [historiaId], references: [id])

  tipo          TipoRegistro         @default(HISTORIA)
  contenido     String?
  plantillaId   String?
  plantilla     Plantilla?           @relation(fields: [plantillaId], references: [id])
  practicaId    String?
  practica      Practica?            @relation(fields: [practicaId], references: [id])
  archivos      Archivo[]            @relation("RegistroArchivo")
  liquidacionId String?
  liquidacion   LiquidacionPractica?

  fecha       DateTime @default(now())
  creadoPorId String
  creadoPor   Usuario  @relation(fields: [creadoPorId], references: [id])
  updatedAt   DateTime @updatedAt
}

enum TipoRegistro {
  HISTORIA
  PRACTICA
  EVOLUCION
  ESTUDIO
}

model Plantilla {
  id          String            @id @default(uuid())
  nombre      String
  descripcion String?
  camposJSON  Json
  tipo        TipoPlantilla     @default(PRACTICA)
  registros   RegistroClinico[]
  practicas   Practica[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

enum TipoPlantilla {
  PRACTICA
  EVOLUCION
  OTRO
}

model Archivo {
  id        String   @id @default(uuid())
  url       String
  tipo      String?
  tamaño   Int?
  createdAt DateTime @default(now())

  // relación genérica
  registros RegistroClinico[] @relation("RegistroArchivo")
}

model Practica {
  id           String      @id @default(uuid())
  codigo       String
  descripcion  String
  valor        Decimal     @db.Decimal(10, 2)
  obraSocial   ObraSocial? @relation(fields: [obraSocialId], references: [id])
  obraSocialId String?

  plantillaId String?
  plantilla   Plantilla? @relation(fields: [plantillaId], references: [id])

  registros RegistroClinico[]

  liquidaciones LiquidacionPractica[]
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
}

model Prescripcion {
  id            String          @id @default(uuid())
  historiaId    String
  historia      HistoriaClinica @relation(fields: [historiaId], references: [id])
  medicamentoId String
  medicamento   Medicamento     @relation(fields: [medicamentoId], references: [id])
  dosis         String?
  observaciones String?
}

model Medicamento {
  id             String         @id @default(uuid())
  nombre         String
  descripcion    String?
  prescripciones Prescripcion[]
}

model SolicitudAccesoHistoria {
  id                String    @id @default(uuid())
  pacienteId        String
  secretariaId      String?
  profesionalId     String
  historiaClinicaId String
  estado            String    @default("pendiente") // pendiente, aprobada, rechazada
  motivo            String?
  fechaSolicitud    DateTime  @default(now())
  fechaResolucion   DateTime?
  expiracionAcceso  DateTime?

  // Relaciones
  historiaClinica HistoriaClinica @relation("Historia_Solicitudes", fields: [historiaClinicaId], references: [id])
  paciente        Paciente        @relation("Paciente_Solicitudes", fields: [pacienteId], references: [id])
  secretaria      Usuario?        @relation("Secretaria_Solicitudes", fields: [secretariaId], references: [id])
  profesional     Usuario         @relation("Profesional_Solicitudes", fields: [profesionalId], references: [id])
}

// =============================
//     OBRAS SOCIALES
// =============================

model ObraSocial {
  id        String           @id @default(uuid())
  nombre    String
  contacto  String?
  planes    PlanObraSocial[]
  pacientes Paciente[]

  // Trazabilidad (quién creó / editó)
  creadaPorId      String
  actualizadaPorId String?

  creadaPor               Usuario                   @relation("ObraSocialCreador", fields: [creadaPorId], references: [id])
  actualizadaPor          Usuario?                  @relation("ObraSocialEditor", fields: [actualizadaPorId], references: [id])
  Practica                Practica[]
  LiquidacionPractica     LiquidacionPractica[]
  ComprobanteFacturacion  ComprobanteFacturacion[]
  DatosFiscalesObraSocial DatosFiscalesObraSocial[]
}

model PlanObraSocial {
  id           String     @id @default(uuid())
  nombre       String
  cobertura    String?
  obraSocialId String
  obraSocial   ObraSocial @relation(fields: [obraSocialId], references: [id])
  pacientes    Paciente[]
}

// =============================
//        FINANZAS
// =============================

model CuentaCorriente {
  id         String   @id @default(uuid())
  pacienteId String   @unique
  paciente   Paciente @relation(fields: [pacienteId], references: [id])
  saldo      Float    @default(0)
  pagos      Pago[]
  createdAt  DateTime @default(now())
}

model Pago {
  id        String          @id @default(uuid())
  cuentaId  String
  cuenta    CuentaCorriente @relation(fields: [cuentaId], references: [id])
  monto     Float
  medioPago String

  // QUIEN COBRA (propietario de la agenda y finanzas)
  profesionalId String
  profesional   Profesional @relation(fields: [profesionalId], references: [id])

  // QUIEN CARGÓ el pago (secretaria/admin/profesional), puede ser null
  creadoPorId String?
  creadoPor   Usuario? @relation("PagoCreador", fields: [creadoPorId], references: [id])

  venta Venta?

  fecha DateTime @default(now())

  @@index([profesionalId])
  @@index([creadoPorId])
}

model Factura {
  id           String   @id @default(uuid())
  pacienteId   String
  paciente     Paciente @relation(fields: [pacienteId], references: [id])
  total        Float
  fechaEmision DateTime @default(now())
  estado       String
}

model Presupuesto {
  id            String      @id @default(uuid())
  pacienteId    String
  paciente      Paciente    @relation(fields: [pacienteId], references: [id])
  profesionalId String
  profesional   Profesional @relation(fields: [profesionalId], references: [id])
  montoEstimado Float
  estado        String
  fecha         DateTime    @default(now())
}

model LiquidacionPractica {
  id                       String                  @id @default(uuid())
  fecha                    DateTime                @default(now())
  pacienteId               String
  paciente                 Paciente                @relation(fields: [pacienteId], references: [id])
  profesionalId            String
  profesional              Profesional             @relation(fields: [profesionalId], references: [id])
  obraSocialId             String
  obraSocial               ObraSocial              @relation(fields: [obraSocialId], references: [id])
  practicaId               String
  practica                 Practica                @relation(fields: [practicaId], references: [id])
  registroId               String?                 @unique
  registro                 RegistroClinico?        @relation(fields: [registroId], references: [id])
  monto                    Decimal                 @db.Decimal(10, 2)
  estado                   EstadoLiquidacion       @default(PENDIENTE)
  fechaPago                DateTime?
  comprobante              String?
  creadaPorId              String
  creadaPor                Usuario                 @relation("LiquidacionCreador", fields: [creadaPorId], references: [id])
  pagadaPorId              String?
  pagadaPor                Usuario?                @relation("LiquidacionPagador", fields: [pagadaPorId], references: [id])
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  ComprobanteFacturacion   ComprobanteFacturacion? @relation(fields: [comprobanteFacturacionId], references: [id])
  comprobanteFacturacionId String?
}

enum EstadoLiquidacion {
  PENDIENTE
  PAGADA
}

model ComprobanteFacturacion {
  id             String      @id @default(uuid())
  fechaEmision   DateTime    @default(now())
  obraSocial     ObraSocial? @relation(fields: [obraSocialId], references: [id])
  obraSocialId   String?
  tipo           String // Factura A, B, C, Recibo, etc.
  numero         String?
  montoTotal     Decimal     @db.Decimal(10, 2)
  montoFacturado Decimal     @db.Decimal(10, 2)
  montoPendiente Decimal     @db.Decimal(10, 2)
  generadoPor    Usuario     @relation(fields: [generadoPorId], references: [id])
  generadoPorId  String
  observaciones  String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relación con las prácticas liquidadas
  liquidaciones LiquidacionPractica[]
}

model DatosFiscalesObraSocial {
  id           String     @id @default(uuid())
  obraSocial   ObraSocial @relation(fields: [obraSocialId], references: [id])
  obraSocialId String
  cuit         String
  razonSocial  String
  condicionIVA String
  direccion    String?
  email        String?
  telefono     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// =============================
//        INVENTARIO
// =============================

model Insumo {
  id            String         @id @default(uuid())
  nombre        String
  cantidad      Float
  unidad        String
  stockMinimo   Float
  vencimiento   DateTime?
  proveedorId   String
  proveedor     Proveedor      @relation(fields: [proveedorId], references: [id])
  consultorioId String
  consultorio   Consultorio    @relation(fields: [consultorioId], references: [id])
  detalles      DetalleOrden[]

  aLaVenta    Boolean  @default(false)
  precioVenta Decimal? @db.Decimal(10, 2)

  lineasVenta VentaLinea[]

  // Dueño del stock (profesional)
  profesionalId String?
  profesional   Profesional? @relation(fields: [profesionalId], references: [id])

  @@index([profesionalId])
}

model Venta {
  id    String   @id @default(uuid())
  fecha DateTime @default(now())
  total Decimal  @db.Decimal(10, 2)

  // Quién registró (secretaria o profesional)
  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  // Opcional: asociar a paciente
  pacienteId String?
  paciente   Paciente? @relation(fields: [pacienteId], references: [id])

  // Relación con líneas
  lineas VentaLinea[]

  // Enlace 1–1 con el pago/registro financiero
  pago   Pago?   @relation(fields: [pagoId], references: [id])
  pagoId String? @unique // importante: 1 venta ↔ 1 pago

  createdAt DateTime @default(now())
}

model VentaLinea {
  id       String  @id @default(uuid())
  ventaId  String
  insumoId String
  cantidad Int
  precio   Decimal @db.Decimal(10, 2) // precio al momento (congelado)
  subtotal Decimal @db.Decimal(10, 2)

  venta  Venta  @relation(fields: [ventaId], references: [id])
  insumo Insumo @relation(fields: [insumoId], references: [id])

  @@index([ventaId])
  @@index([insumoId])
}

model Proveedor {
  id       String        @id @default(uuid())
  nombre   String
  contacto String?
  email    String?
  insumos  Insumo[]
  ordenes  OrdenCompra[]
}

model OrdenCompra {
  id            String         @id @default(uuid())
  proveedorId   String
  proveedor     Proveedor      @relation(fields: [proveedorId], references: [id])
  fecha         DateTime       @default(now())
  total         Float
  estado        String
  detalles      DetalleOrden[]
  consultorioId String
  consultorio   Consultorio    @relation(fields: [consultorioId], references: [id])
}

model DetalleOrden {
  id         String      @id @default(uuid())
  ordenId    String
  insumoId   String
  orden      OrdenCompra @relation(fields: [ordenId], references: [id])
  insumo     Insumo      @relation(fields: [insumoId], references: [id])
  cantidad   Float
  precioUnit Float
}

// =============================
//      CONFIGURACIÓN
// =============================

model Configuracion {
  id               String      @id @default(uuid())
  consultorioId    String      @unique
  consultorio      Consultorio @relation(fields: [consultorioId], references: [id])
  horarioAtencion  String?
  diasNoLaborables String?
}

model ConfiguracionNotificacion {
  id            String      @id @default(uuid())
  consultorioId String      @unique
  consultorio   Consultorio @relation(fields: [consultorioId], references: [id])
  activo        Boolean     @default(true)
  horarioEnvio  String?
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "./ERD/diagram.svg" // ✅ ruta + extensión válidas
  format   = "svg"
}
